name: LensCore Accessibility CI

on:
  workflow_call:
    inputs:
      mode:
        description: 'Deployment mode (vercel | nextjs | custom)'
        required: true
        type: string
      url:
        description: 'Target URL to scan (optional, auto-resolved if not provided)'
        required: false
        type: string
    secrets:
      VERCEL_TOKEN:
        required: false
      VERCEL_ORG_ID:
        required: false
      VERCEL_PROJECT_ID:
        required: false

jobs:
  accessibility:
    name: Run LensCore Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Validate inputs
        run: |
          case "${{ inputs.mode }}" in
            vercel|nextjs|custom)
              echo "Mode validated: ${{ inputs.mode }}"
              ;;
            *)
              echo "Invalid mode: ${{ inputs.mode }}. Allowed values: vercel, nextjs, custom" >&2
              exit 1
              ;;
          esac

      - name: Install Vercel CLI
        if: ${{ inputs.mode == 'vercel' }}
        run: npm install -g vercel@latest

      - name: Deploy with Vercel
        if: ${{ inputs.mode == 'vercel' }}
        id: vercel_deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -euo pipefail
          vercel pull --yes --token "$VERCEL_TOKEN" --environment=preview || true
          vercel build --token "$VERCEL_TOKEN" || true
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token "$VERCEL_TOKEN" 2>&1)
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.vercel\.app' | head -n1 || echo "")
          if [ -z "$PREVIEW_URL" ]; then
            PREVIEW_URL="${{ inputs.url }}"
          fi
          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to obtain preview URL" >&2
            exit 1
          fi
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $PREVIEW_URL"

      - name: Build application
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: npm run build
        continue-on-error: false

      - name: Start application
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          npm start > /tmp/app.log 2>&1 &
          echo $! > /tmp/app.pid
        continue-on-error: false

      - name: Wait for application
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          timeout=300
          elapsed=0
          port=3000
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:$port > /dev/null 2>&1; then
              echo "Application is ready"
              exit 0
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done
          echo "Application failed to start" >&2
          exit 1

      - name: Resolve target URL
        id: resolve_url
        run: |
          if [ "${{ inputs.mode }}" == "vercel" ]; then
            TARGET_URL="${{ steps.vercel_deploy.outputs.preview_url }}"
          elif [ "${{ inputs.mode }}" == "nextjs" ] || [ "${{ inputs.mode }}" == "custom" ]; then
            if [ -n "${{ inputs.url }}" ]; then
              TARGET_URL="${{ inputs.url }}"
            else
              TARGET_URL="http://localhost:3000"
            fi
          else
            TARGET_URL="${{ inputs.url }}"
          fi
          if [ -z "$TARGET_URL" ]; then
            echo "Target URL is required" >&2
            exit 1
          fi
          echo "target_url=$TARGET_URL" >> $GITHUB_OUTPUT
          echo "Target URL: $TARGET_URL"

      - name: Install LensCore CLI
        run: npm install -g @accesstime/lenscore@latest

      - name: Setup LensCore configuration
        run: |
          mkdir -p ~/.lenscore
          cat > ~/.lenscore/config.json << 'EOF'
          {
            "mode": "local",
            "docker": {
              "image": "lenscore:latest",
              "port": 3001
            },
            "remote": {
              "baseUrl": "http://localhost:3001"
            },
            "openai": {
              "apiKey": "",
              "model": "gpt-3.5-turbo",
              "enabled": false
            }
          }
          EOF

      - name: Start LensCore Docker services
        run: |
          echo "Starting LensCore services..."
          lens-core up || true
          sleep 30
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "LensCore is ready"
              exit 0
            fi
            echo "Waiting for LensCore... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          echo "LensCore health check failed" >&2
          docker ps -a || true
          if [ -f ~/.lenscore/docker-compose.yml ]; then
            docker-compose -f ~/.lenscore/docker-compose.yml logs --tail=50 || true
          fi
          exit 1

      - name: Run accessibility scan
        id: scan
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          set -euo pipefail
          MAX_URLS=10
          SCAN_DEPTH=2
          TIMEOUT=15000
          echo "Scanning: $TARGET_URL"
          lens-core scan "$TARGET_URL" \
            -u "$MAX_URLS" \
            -d "$SCAN_DEPTH" \
            -t "$TIMEOUT" \
            > /tmp/scan-output.txt 2>&1 || true
          python3 << 'PYEOF'
          import json
          import sys
          import re

          with open('/tmp/scan-output.txt', 'r') as f:
              content = f.read()

          json_match = re.search(r'\{[\s\S]*\}', content)
          if json_match:
              try:
                  json_data = json.loads(json_match.group())
                  with open('lenscore-report.json', 'w') as out:
                      json.dump(json_data, out, indent=2)
                  sys.exit(0)
              except:
                  pass

          with open('lenscore-report.json', 'w') as out:
              json.dump({"accessibility": {"results": []}}, out, indent=2)
          PYEOF
          if [ ! -f lenscore-report.json ]; then
            echo '{"accessibility": {"results": []}}' > lenscore-report.json
          fi
          echo "Scan completed. Report generated: lenscore-report.json"

      - name: Generate HTML report
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          MAX_URLS=10
          SCAN_DEPTH=2
          TIMEOUT=15000
          lens-core scan "$TARGET_URL" \
            -u "$MAX_URLS" \
            -d "$SCAN_DEPTH" \
            -t "$TIMEOUT" \
            --web || true

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lenscore-accessibility-report
          path: |
            lenscore-report.json
            ~/.lenscore/web/output/*.html
          if-no-files-found: warn
          retention-days: 7

      - name: Check for violations
        run: |
          set -euo pipefail
          if [ ! -f lenscore-report.json ]; then
            echo "Report file not found" >&2
            exit 1
          fi
          VIOLATIONS=$(jq '[.accessibility.results[]? | .violations | length] | add // 0' lenscore-report.json 2>/dev/null || echo "0")
          TOTAL_VIOLATIONS=${VIOLATIONS:-0}
          echo "Total violations found: $TOTAL_VIOLATIONS"
          if [ "$TOTAL_VIOLATIONS" -gt 0 ]; then
            echo "::error::Accessibility violations detected: $TOTAL_VIOLATIONS"
            echo "violations_count=$TOTAL_VIOLATIONS" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "No violations found"

      - name: Stop application
        if: ${{ always() && (inputs.mode == 'nextjs' || inputs.mode == 'custom') }}
        run: |
          if [ -f /tmp/app.pid ]; then
            kill $(cat /tmp/app.pid) 2>/dev/null || true
          fi
          pkill -f "npm start" || true

      - name: Stop LensCore services
        if: ${{ always() }}
        run: |
          lens-core down || true
