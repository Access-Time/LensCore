name: LensCore Accessibility CI

on:
  workflow_call:
    inputs:
      mode:
        description: 'Deployment mode (vercel | nextjs | custom)'
        required: true
        type: string
      url:
        description: 'Target URL to scan (if already deployed/known)'
        required: false
        type: string
    secrets:
      VERCEL_TOKEN:
        required: false
      VERCEL_ORG_ID:
        required: false
      VERCEL_PROJECT_ID:
        required: false

jobs:
  accessibility:
    name: Run LensCore Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install jq (for JSON processing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine scan target (init)
        id: init
        run: |
          echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT

      - name: Validate inputs
        run: |
          case "${{ inputs.mode }}" in
            vercel|nextjs|custom) echo "Mode OK" ;;
            *) echo "Invalid mode: ${{ inputs.mode }}. Allowed: vercel|nextjs|custom" >&2; exit 1 ;;
          esac

      - name: Install Vercel CLI (if mode=vercel)
        if: ${{ inputs.mode == 'vercel' }}
        run: npm i -g vercel@latest

      - name: Deploy with Vercel CLI (if mode=vercel)
        id: vercel_deploy
        if: ${{ inputs.mode == 'vercel' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_PROJECT_PATH: ${{ vars.VERCEL_PROJECT_PATH }}
          VERCEL_ENVIRONMENT: ${{ vars.VERCEL_ENVIRONMENT }}
        run: |
          set -euo pipefail
          WORKDIR=${VERCEL_PROJECT_PATH:-.}
          echo "Working dir: $WORKDIR"
          cd "$WORKDIR"
          vercel pull --yes --token "$VERCEL_TOKEN" --environment=${VERCEL_ENVIRONMENT:-preview}
          vercel build --token "$VERCEL_TOKEN"
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token "$VERCEL_TOKEN")
          echo "$DEPLOY_OUTPUT"
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | tail -n1)
          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to obtain Vercel preview URL" >&2
            exit 1
          fi
          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Resolve target URL for Vercel
        if: ${{ inputs.mode == 'vercel' }}
        id: resolve-vercel
        run: |
          # Pick URL from action outputs, fallback to input url if provided
          PREVIEW_URL="${{ steps.vercel_deploy.outputs.preview-url }}"
          if [ -z "$PREVIEW_URL" ]; then
            PREVIEW_URL="${{ inputs.url }}"
          fi
          if [ -z "$PREVIEW_URL" ]; then
            echo "Vercel preview URL not found and inputs.url not provided" >&2
            exit 1
          fi
          echo "target_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Install dependencies (nextjs/custom)
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          npm ci || npm install

      - name: Build app (nextjs/custom)
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          ${BUILD_COMMAND:-npm run build}
        env:
          BUILD_COMMAND: ${{ vars.BUILD_COMMAND }}

      - name: Start app (nextjs/custom)
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          nohup bash -lc "${START_COMMAND:-npm start}" >/dev/null 2>&1 &
          echo $! > app.pid
        env:
          START_COMMAND: ${{ vars.START_COMMAND }}

      - name: Wait for app to be ready (nextjs/custom)
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        run: |
          npx -y wait-on@7.2.0 http-get://localhost:${{ vars.PORT || 3000 }} --timeout 300000

      - name: Resolve target URL (nextjs/custom)
        if: ${{ inputs.mode == 'nextjs' || inputs.mode == 'custom' }}
        id: resolve-local
        run: |
          TARGET_URL="${{ inputs.url }}"
          if [ -z "$TARGET_URL" ]; then
            TARGET_URL="http://localhost:${{ vars.PORT || 3000 }}"
          fi
          echo "target_url=$TARGET_URL" >> $GITHUB_OUTPUT

      - name: Install LensCore CLI
        run: |
          npm i -g @accesstime/lenscore@${LENSCORE_VERSION}
        env:
          LENSCORE_VERSION: 0.1.21

      - name: Run LensCore scan (JSON)
        id: scan
        env:
          TARGET_URL: ${{ steps.resolve-vercel.outputs.target_url || steps.resolve-local.outputs.target_url || inputs.url }}
          MAX_URLS: ${{ vars.MAX_URLS || 10 }}
          SCAN_DEPTH: ${{ vars.SCAN_DEPTH || 2 }}
          TIMEOUT: ${{ vars.TIMEOUT || 15000 }}
        run: |
          if [ -z "$TARGET_URL" ]; then
            echo "Target URL is required but not provided" >&2
            exit 1
          fi
          echo "Scanning: $TARGET_URL"
          lens-core scan "$TARGET_URL" -u "$MAX_URLS" -d "$SCAN_DEPTH" -t "$TIMEOUT" > lenscore-report.json

      - name: Generate HTML report (optional)
        if: ${{ vars.USE_WEB_REPORT == 'true' }}
        env:
          TARGET_URL: ${{ steps.resolve-vercel.outputs.target_url || steps.resolve-local.outputs.target_url || inputs.url }}
          MAX_URLS: ${{ vars.MAX_URLS || 10 }}
          SCAN_DEPTH: ${{ vars.SCAN_DEPTH || 2 }}
          TIMEOUT: ${{ vars.TIMEOUT || 15000 }}
        run: |
          lens-core scan "$TARGET_URL" -u "$MAX_URLS" -d "$SCAN_DEPTH" -t "$TIMEOUT" --web || true

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lenscore-reports
          path: |
            lenscore-report.json
            ~/.lenscore/web/output/*.html
          if-no-files-found: warn

      - name: Fail if violations found
        if: ${{ vars.FAIL_ON_VIOLATIONS == 'true' || vars.FAIL_ON_VIOLATIONS == '' }}
        run: |
          VIOLATIONS=$(jq '[.accessibility.results[]? | .violations | length] | add // 0' lenscore-report.json)
          echo "Violations found: $VIOLATIONS"
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "Accessibility violations detected" >&2
            exit 1
          fi

      - name: Stop app (nextjs/custom)
        if: ${{ (inputs.mode == 'nextjs' || inputs.mode == 'custom') && always() }}
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi
