name: LensCore Accessibility CI - Vercel

on:
  workflow_call:
    inputs:
      url:
        description: 'Target URL to scan (optional, auto-resolved from Vercel deployment)'
        required: false
        type: string
      vercel_org_id:
        description: 'Vercel Organization ID'
        required: true
        type: string
      vercel_project_id:
        description: 'Vercel Project ID'
        required: true
        type: string
      max_urls:
        description: 'Maximum number of URLs to scan'
        required: false
        type: number
        default: 10
      scan_depth:
        description: 'Depth of crawling'
        required: false
        type: number
        default: 2
      timeout:
        description: 'Timeout for each page scan in milliseconds'
        required: false
        type: number
        default: 15000
    secrets:
      VERCEL_TOKEN:
        required: true

jobs:
  accessibility:
    name: Run LensCore Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # DETECT PACKAGE MANAGER
      # -------------------------
      - name: Detect package manager
        id: detect_pm
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "lockfile=pnpm-lock.yaml" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=" >> $GITHUB_OUTPUT
          fi

      # -------------------------
      # SETUP NODE + CACHE
      # -------------------------
      - name: Enable corepack (pnpm/yarn)
        if: steps.detect_pm.outputs.manager == 'pnpm' || steps.detect_pm.outputs.manager == 'yarn'
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------
      # INSTALL DEPENDENCIES
      # -------------------------
      - name: Install dependencies
        run: |
          case "${{ steps.detect_pm.outputs.manager }}" in
            "npm")
              if [ -n "${{ steps.detect_pm.outputs.lockfile }}" ]; then npm ci; else npm install; fi
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
          esac

      # -------------------------
      # SYSTEM DEPENDENCIES
      # -------------------------
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # -------------------------
      # DOCKER PREPARATION
      # -------------------------
      - name: Ensure Docker is running
        run: |
          echo "Starting Docker daemon..."
          sudo systemctl start docker
          sudo chmod 666 /var/run/docker.sock || true
          docker info

      # -------------------------
      # VERCEL DEPLOYMENT
      # -------------------------
      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy with Vercel
        id: vercel_deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ inputs.vercel_org_id }}
          VERCEL_PROJECT_ID: ${{ inputs.vercel_project_id }}
        run: |
          set -euo pipefail
          vercel pull --yes --token "$VERCEL_TOKEN" --environment=preview || true
          vercel build --token "$VERCEL_TOKEN" || true
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token "$VERCEL_TOKEN" 2>&1)
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.vercel\.app' | head -n1 || echo "")
          if [ -z "$PREVIEW_URL" ]; then
            PREVIEW_URL="${{ inputs.url }}"
          fi
          if [ -z "$PREVIEW_URL" ]; then
            echo "Failed to obtain preview URL" >&2
            exit 1
          fi
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $PREVIEW_URL"

      # -------------------------
      # RESOLVE URL
      # -------------------------
      - name: Resolve target URL
        id: resolve_url
        run: |
          TARGET_URL="${{ steps.vercel_deploy.outputs.preview_url }}"
          if [ -z "$TARGET_URL" ]; then
            echo "Target URL is required" >&2
            exit 1
          fi
          echo "target_url=$TARGET_URL" >> $GITHUB_OUTPUT
          echo "Target URL: $TARGET_URL"

      # -------------------------
      # INSTALL LENSCORE
      # -------------------------
      - name: Install LensCore CLI
        run: npm install -g @accesstime/lenscore@latest

      # -------------------------
      # CONFIGURE LENSCORE
      # -------------------------
      - name: Setup LensCore configuration
        run: |
          mkdir -p ~/.lenscore
          cat > ~/.lenscore/config.json << 'EOF'
          {
            "mode": "local",
            "docker": {
              "image": "lenscore:latest",
              "port": 3001
            },
            "remote": {
              "baseUrl": "http://localhost:3001"
            },
            "openai": {
              "apiKey": "",
              "model": "gpt-3.5-turbo",
              "enabled": false
            }
          }
          EOF

      # -------------------------
      # START LENSCORE DOCKER SERVICES
      # -------------------------
      - name: Start LensCore services
        run: |
          echo "Starting LensCore services..."
          lens-core up || true

          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -sf http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "✅ LensCore is ready"
              exit 0
            fi
            echo "⏳ Waiting for LensCore... ($elapsed/$timeout)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          echo "❌ LensCore health check failed"
          docker ps -a
          exit 1

      # -------------------------
      # RUN ACCESSIBILITY SCAN (JSON)
      # -------------------------
      - name: Run accessibility scan
        id: scan
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          echo "Scanning $TARGET_URL"
          lens-core scan "$TARGET_URL" \
            -u "${{ inputs.max_urls }}" \
            -d "${{ inputs.scan_depth }}" \
            -t "${{ inputs.timeout }}" \
            -o report.json || true

          if [ ! -f report.json ]; then
            echo '{"accessibility":{"results":[]}}' > report.json
          fi

      # -------------------------
      # RUN HTML REPORT GENERATION
      # -------------------------
      - name: Generate HTML report
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          lens-core scan "$TARGET_URL" \
            -u "${{ inputs.max_urls }}" \
            -d "${{ inputs.scan_depth }}" \
            -t "${{ inputs.timeout }}" \
            --web || true

      # -------------------------
      # UPLOAD ARTIFACTS
      # -------------------------
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lenscore-accessibility-report
          path: |
            report.json
            ~/.lenscore/web/output/*.html
          retention-days: 7
          if-no-files-found: warn

      # -------------------------
      # CHECK VIOLATIONS
      # -------------------------
      - name: Check for violations
        run: |
          VIOLATIONS=$(jq '[.accessibility.results[]? | .violations | length] | add // 0' report.json)
          echo "Total violations: $VIOLATIONS"

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "::error::Accessibility violations detected: $VIOLATIONS"
            exit 1
          fi

          echo "✅ No violations found"

      # -------------------------
      # CLEANUP RESOURCES
      # -------------------------
      - name: Stop LensCore services
        if: always()
        run: |
          lens-core down || true
