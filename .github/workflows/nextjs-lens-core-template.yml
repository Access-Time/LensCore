name: LensCore Accessibility CI - Next.js

on:
  workflow_call:
    inputs:
      url:
        description: 'Target URL to scan (default: http://localhost:3000)'
        required: false
        type: string
        default: 'http://localhost:3000'
      port:
        description: 'Port where Next.js application will run'
        required: false
        type: number
        default: 3000
      max_urls:
        description: 'Maximum number of URLs to scan'
        required: false
        type: number
        default: 10
      scan_depth:
        description: 'Depth of crawling'
        required: false
        type: number
        default: 2
      timeout:
        description: 'Timeout for each page scan (ms)'
        required: false
        type: number
        default: 15000

jobs:
  accessibility:
    name: Run LensCore Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # DETECT PACKAGE MANAGER
      # -------------------------
      - name: Detect package manager
        id: detect_pm
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "lockfile=pnpm-lock.yaml" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=" >> $GITHUB_OUTPUT
          fi

      # -------------------------
      # SETUP NODE + CACHE
      # -------------------------
      - name: Enable corepack (pnpm/yarn)
        if: steps.detect_pm.outputs.manager == 'pnpm' || steps.detect_pm.outputs.manager == 'yarn'
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------
      # INSTALL DEPENDENCIES
      # -------------------------
      - name: Install dependencies
        run: |
          case "${{ steps.detect_pm.outputs.manager }}" in
            "npm")
              if [ -n "${{ steps.detect_pm.outputs.lockfile }}" ]; then npm ci; else npm install; fi
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
          esac

      # -------------------------
      # SYSTEM DEPENDENCIES
      # -------------------------
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      # -------------------------
      # DOCKER PREPARATION
      # -------------------------
      - name: Ensure Docker is running
        run: |
          echo "Starting Docker daemon..."
          sudo systemctl start docker
          sudo chmod 666 /var/run/docker.sock || true
          docker info

      # -------------------------
      # BUILD APP
      # -------------------------
      - name: Build application
        env:
          NODE_ENV: production
        run: |
          case "${{ steps.detect_pm.outputs.manager }}" in
            "npm") npm run build || exit 1 ;;
            "yarn") yarn build || exit 1 ;;
            "pnpm") pnpm build || exit 1 ;;
          esac

      # -------------------------
      # START APP
      # -------------------------
      - name: Start application
        env:
          NODE_ENV: production
          PORT: ${{ inputs.port }}
        run: |
          case "${{ steps.detect_pm.outputs.manager }}" in
            "npm") npm start > /tmp/app.log 2>&1 & ;;
            "yarn") yarn start > /tmp/app.log 2>&1 & ;;
            "pnpm") pnpm start > /tmp/app.log 2>&1 & ;;
          esac
          echo $! > /tmp/app.pid

      # -------------------------
      # WAIT FOR APP
      # -------------------------
      - name: Wait for application
        run: |
          timeout=300
          elapsed=0
          port=${{ inputs.port }}
          
          while [ $elapsed -lt $timeout ]; do
            if curl -sf "http://localhost:$port" > /dev/null 2>&1; then
              sleep 20
              CONTENT=$(curl -sL "http://localhost:$port" 2>/dev/null || echo "")
              if echo "$CONTENT" | grep -qi "example domain"; then
                echo "::error::Application is serving placeholder, not Next.js app"
                echo "Application logs:"
                cat /tmp/app.log 2>/dev/null | tail -50 || true
                exit 1
              fi
              exit 0
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          echo "::error::Application failed to start"
          cat /tmp/app.log 2>/dev/null | tail -50 || true
          exit 1

      # -------------------------
      # RESOLVE URL
      # -------------------------
      - name: Resolve target URL
        id: resolve_url
        run: |
          URL="${{ inputs.url }}"
          if [ "$URL" == "" ]; then
            URL="http://localhost:${{ inputs.port }}"
          fi
          echo "target_url=$URL" >> $GITHUB_OUTPUT

      # -------------------------
      # INSTALL LENSCORE
      # -------------------------
      - name: Install LensCore CLI
        run: npm install -g @accesstime/lenscore@latest

      # -------------------------
      # CONFIGURE LENSCORE
      # -------------------------
      - name: Setup LensCore configuration
        run: |
          mkdir -p ~/.lenscore
          cat > ~/.lenscore/config.json << 'EOF'
          {
            "mode": "local",
            "docker": {
              "image": "lenscore:latest",
              "port": 3001
            },
            "remote": {
              "baseUrl": "http://localhost:3001"
            },
            "openai": {
              "apiKey": "",
              "model": "gpt-3.5-turbo",
              "enabled": false
            }
          }
          EOF

      # -------------------------
      # START LENSCORE DOCKER SERVICES
      # -------------------------
      - name: Start LensCore services
        run: |
          echo "Starting LensCore services..."
          lens-core up || true

          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -sf http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "‚úÖ LensCore is ready"
              exit 0
            fi
            echo "‚è≥ Waiting for LensCore... ($elapsed/$timeout)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

          echo "‚ùå LensCore health check failed"
          docker ps -a
          exit 1

      # -------------------------
      # VERIFY APP CONTENT BEFORE SCAN
      # -------------------------
      - name: Verify app content before scan
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          CONTENT=$(curl -sL "$TARGET_URL" 2>/dev/null || echo "")
          if echo "$CONTENT" | grep -qi "example domain"; then
            echo "::error::Application is serving placeholder content, not Next.js app"
            exit 1
          fi

      # -------------------------
      # RUN ACCESSIBILITY SCAN (JSON)
      # -------------------------
      - name: Run accessibility scan
        id: scan
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          lens-core scan "$TARGET_URL" \
            -u "${{ inputs.max_urls }}" \
            -d "${{ inputs.scan_depth }}" \
            -t "${{ inputs.timeout }}" \
            --skip-cache \
            -o report.json || true

          if [ ! -f report.json ]; then
            echo '{"accessibility":{"results":[]}}' > report.json
          fi

          SCAN_RESULTS=$(jq '.accessibility.results | length' report.json 2>/dev/null || echo "0")
          CRAWL_PAGES=$(jq '.crawl.totalPages // 0' report.json 2>/dev/null || echo "0")

          echo "Scan results: $SCAN_RESULTS pages scanned"
          echo "Crawl results: $CRAWL_PAGES pages discovered"

          if [ "$SCAN_RESULTS" -eq 0 ] && [ "$CRAWL_PAGES" -eq 0 ]; then
            echo "::info::Crawler found 0 pages (common for Next.js apps with client-side routing)."
            echo "::info::Using fallback: testing main page directly with 'lens-core test'..."
            
            lens-core test "$TARGET_URL" \
              -t "${{ inputs.timeout }}" \
              --skip-cache > /tmp/test_output.txt 2>&1 || true
            
            echo "Extracting JSON from test output..."
            if jq empty /tmp/test_output.txt 2>/dev/null; then
              cp /tmp/test_output.txt report-fallback.json
              echo "‚úÖ Found valid JSON in output"
            else
              awk '/^\{/,/^\}$/' /tmp/test_output.txt > report-fallback.json 2>/dev/null || true
              if [ -f report-fallback.json ] && jq empty report-fallback.json 2>/dev/null; then
                echo "‚úÖ Extracted JSON using awk"
              else
                echo "‚ö†Ô∏è Could not extract JSON, trying alternative method..."
                jq -s '.[] | select(type == "object")' /tmp/test_output.txt > report-fallback.json 2>/dev/null || true
              fi
            fi
            
            if [ -f report-fallback.json ] && jq empty report-fallback.json 2>/dev/null; then
              echo "Analyzing test results..."
              
              HAS_URL=$(jq -r 'if .url then "yes" else "no" end' report-fallback.json 2>/dev/null || echo "no")
              VIOLATIONS_COUNT=$(jq '.violations | length' report-fallback.json 2>/dev/null || echo "0")
              PASSES_COUNT=$(jq '.passes | length' report-fallback.json 2>/dev/null || echo "0")
              HAS_SCORE=$(jq -r 'if .score then "yes" else "no" end' report-fallback.json 2>/dev/null || echo "no")
              
              echo "Test result analysis:"
              echo "  - Has URL: $HAS_URL"
              echo "  - Violations count: $VIOLATIONS_COUNT"
              echo "  - Passes count: $PASSES_COUNT"
              echo "  - Has score: $HAS_SCORE"
              
              if [ "$HAS_URL" = "yes" ] && ([ "$VIOLATIONS_COUNT" -gt 0 ] || [ "$PASSES_COUNT" -gt 0 ] || [ "$HAS_SCORE" = "yes" ]); then
                echo "‚úÖ Fallback test found valid accessibility results"
                echo "  - Violations: $VIOLATIONS_COUNT"
                echo "  - Passes: $PASSES_COUNT"
                
                jq '{
                  "crawl": {"pages": [], "totalPages": 1, "crawlTime": 0},
                  "accessibility": {
                    "results": [.],
                    "totalPages": 1,
                    "testTime": (.metadata.processingTime // 0)
                  },
                  "totalTime": (.metadata.processingTime // 0)
                }' report-fallback.json > report.json
                
                if jq empty report.json 2>/dev/null; then
                  SCAN_RESULTS=1
                  CRAWL_PAGES=1
                  echo "‚úÖ Successfully converted test results to scan report format"
                else
                  echo "::error::Failed to create valid report.json from test results"
                fi
              else
                echo "::warning::Fallback test did not find valid accessibility results."
                echo "  - URL present: $HAS_URL"
                echo "  - Violations: $VIOLATIONS_COUNT"
                echo "  - Passes: $PASSES_COUNT"
                echo "  - Score: $HAS_SCORE"
                echo "Test output preview:"
                head -50 /tmp/test_output.txt || true
              fi
            else
              echo "::warning::Could not extract valid JSON from fallback test output."
              echo "Test output preview:"
              head -50 /tmp/test_output.txt || true
            fi
          fi

          if [ "$SCAN_RESULTS" -eq 0 ]; then
            echo "::warning::No pages were scanned."
            if [ "$CRAWL_PAGES" -eq 0 ]; then
              echo "::warning::Crawler found 0 pages. The application may not have any links or the page may be empty."
              echo "::info::Tip: Ensure your application has HTML links (<a> tags) or use a SPA framework that renders links server-side."
            else
              echo "::warning::Crawler found $CRAWL_PAGES pages but accessibility scan returned 0 results."
            fi
            echo "Report content:"
            jq '.' report.json | head -30 || cat report.json | head -30
          else
            echo "‚úÖ Successfully scanned $SCAN_RESULTS page(s)"
          fi

      # -------------------------
      # RUN HTML REPORT GENERATION
      # -------------------------
      - name: Generate HTML report
        env:
          TARGET_URL: ${{ steps.resolve_url.outputs.target_url }}
        run: |
          lens-core scan "$TARGET_URL" \
            -u "${{ inputs.max_urls }}" \
            -d "${{ inputs.scan_depth }}" \
            -t "${{ inputs.timeout }}" \
            --skip-cache \
            --web || true

      # -------------------------
      # UPLOAD ARTIFACTS
      # -------------------------
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lenscore-accessibility-report
          path: |
            report.json
            ~/.lenscore/web/output/*.html
          retention-days: 7
          if-no-files-found: warn

      # -------------------------
      # CHECK VIOLATIONS
      # -------------------------
      - name: Check for violations
        run: |
          VIOLATIONS=$(jq '[.accessibility.results[]? | .violations | length] | add // 0' report.json)
          echo "Total violations: $VIOLATIONS"

          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "=========================================="
            echo "üî¥ ACCESSIBILITY VIOLATIONS DETECTED"
            echo "=========================================="
            echo ""
            
            PAGE_COUNT=$(jq '.accessibility.results | length' report.json)
            echo "Pages scanned: $PAGE_COUNT"
            echo "Total violations: $VIOLATIONS"
            echo ""
            
            echo "--- Violation Details ---"
            jq -r '.accessibility.results[]? | 
              "Page: \(.url // "Unknown")",
              (.violations[]? | 
                "  ‚ùå \(.id // "unknown") [\(.impact // "unknown")]",
                "     Description: \(.description // "N/A")",
                "     Help: \(.help // "N/A")",
                "     Help URL: \(.helpUrl // "N/A")",
                (.nodes[]? | 
                  "     - Element: \(.target | join(", ") // "N/A")",
                  "       HTML: \(.html // "N/A" | .[0:100])",
                  "       Summary: \(.failureSummary // .any[]?[0].message // "N/A" | .[0:200])"
                ),
                ""
              )
            ' report.json || true
            
            echo ""
            echo "=========================================="
            echo "üí° How to fix:"
            echo "  1. Review each violation above"
            echo "  2. Check the Help URL for detailed guidance"
            echo "  3. Fix the issues in your code"
            echo "  4. Re-run the workflow to verify fixes"
            echo "=========================================="
            echo ""
            
            echo "::error::Accessibility violations detected: $VIOLATIONS"
            exit 1
          fi

          echo "‚úÖ No violations found"

      # -------------------------
      # CLEANUP RESOURCES
      # -------------------------
      - name: Stop application
        if: always()
        run: |
          if [ -f /tmp/app.pid ]; then kill $(cat /tmp/app.pid) || true; fi
          pkill -f "npm start" || true
          pkill -f "pnpm start" || true
          pkill -f "yarn start" || true

      - name: Stop LensCore services
        if: always()
        run: |
          lens-core down || true
