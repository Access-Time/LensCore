name: LensCore Accessibility CI

on:
  workflow_call:
    inputs:
      url:
        description: 'Application URL to scan'
        required: false
        type: string
        default: 'http://localhost:3000'
      port:
        description: 'Application port'
        required: false
        type: number
        default: 3000
      max_urls:
        description: 'Maximum number of URLs to scan'
        required: false
        type: number
        default: 10
      scan_depth:
        description: 'Depth of crawling'
        required: false
        type: number
        default: 2
      timeout:
        description: 'Timeout for each page scan (ms)'
        required: false
        type: number
        default: 15000

jobs:
  accessibility:
    name: Run LensCore Accessibility Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect package manager
        id: detect_pm
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=package-lock.json" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "lockfile=yarn.lock" >> $GITHUB_OUTPUT
          elif [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
            echo "lockfile=pnpm-lock.yaml" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "lockfile=" >> $GITHUB_OUTPUT
          fi

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install docker-compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Extract port from URL
        id: extract_port
        run: |
          URL="${{ inputs.url }}"
          PORT="${{ inputs.port }}"
          if [ -z "$PORT" ] || [ "$PORT" = "0" ]; then
            if echo "$URL" | grep -qE ':[0-9]+'; then
              PORT=$(echo "$URL" | sed -E 's/.*:([0-9]+).*/\1/')
            else
              PORT=3000
            fi
          fi
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "app_url=http://app:$PORT" >> $GITHUB_OUTPUT
          echo "localhost_url=http://localhost:$PORT" >> $GITHUB_OUTPUT

      - name: Setup LensCore
        run: |
          npm install -g @accesstime/lenscore@latest
          mkdir -p ~/.lenscore
          cat > ~/.lenscore/config.json << 'CONFIG_EOF'
          {
            "mode": "local",
            "docker": {
              "image": "lenscore:latest",
              "port": 3001
            },
            "remote": {
              "baseUrl": "http://localhost:3001"
            },
            "openai": {
              "apiKey": "",
              "model": "gpt-3.5-turbo",
              "enabled": false
            }
          }
          CONFIG_EOF
          lens-core build

      - name: Prepare Dockerfile
        run: |
          PM="${{ steps.detect_pm.outputs.manager }}"
          PORT="${{ steps.extract_port.outputs.port }}"

          if [ ! -f Dockerfile ]; then
            echo "Dockerfile not found. Creating a basic Dockerfile for $PM..."
            
            if [ "$PM" = "npm" ]; then
              {
                echo "FROM node:20-alpine"
                echo "WORKDIR /app"
                echo "COPY package*.json ./"
                echo "RUN npm ci"
                echo "COPY . ."
                echo "RUN npm run build || true"
                echo "EXPOSE ${PORT}"
                echo "CMD [\"npm\", \"start\"]"
              } > Dockerfile
            elif [ "$PM" = "yarn" ]; then
              {
                echo "FROM node:20-alpine"
                echo "WORKDIR /app"
                echo "RUN corepack enable && corepack prepare yarn@stable --activate"
                echo "COPY package.json yarn.lock ./"
                echo "RUN yarn install --frozen-lockfile"
                echo "COPY . ."
                echo "RUN yarn build || true"
                echo "EXPOSE ${PORT}"
                echo "CMD [\"yarn\", \"start\"]"
              } > Dockerfile
            elif [ "$PM" = "pnpm" ]; then
              {
                echo "FROM node:20-alpine"
                echo "WORKDIR /app"
                echo "RUN corepack enable && corepack prepare pnpm@latest --activate"
                echo "COPY package.json pnpm-lock.yaml ./"
                echo "RUN pnpm install --frozen-lockfile"
                echo "COPY . ."
                echo "RUN pnpm build || true"
                echo "EXPOSE ${PORT}"
                echo "CMD [\"pnpm\", \"start\"]"
              } > Dockerfile
            else
              echo "::warning::Unknown package manager: $PM. Creating generic Dockerfile..."
              {
                echo "FROM node:20-alpine"
                echo "WORKDIR /app"
                echo "COPY package*.json ./"
                echo "RUN npm install --production || true"
                echo "COPY . ."
                echo "EXPOSE ${PORT}"
                echo "CMD [\"node\", \"index.js\"]"
              } > Dockerfile
            fi
            echo "✓ Created basic Dockerfile for $PM"
          else
            echo "✓ Using existing Dockerfile"
          fi

      - name: Get LensCore network name
        id: get_lenscore_network
        run: |
          LENSCORE_NETWORK=$(docker network ls | grep lenscore | awk '{print $2}' | head -1 || echo "")
          if [ -z "$LENSCORE_NETWORK" ]; then
            LENSCORE_NETWORK=$(docker network ls | grep lenscore | awk '{print $1}' | head -1 || echo "")
            if [ -n "$LENSCORE_NETWORK" ]; then
              LENSCORE_NETWORK=$(docker network inspect "$LENSCORE_NETWORK" --format '{{.Name}}' 2>/dev/null || echo "")
            fi
          fi
          if [ -z "$LENSCORE_NETWORK" ]; then
            echo "::error::LensCore network not found. Make sure lens-core build completed successfully."
            exit 1
          fi
          echo "network_name=$LENSCORE_NETWORK" >> $GITHUB_OUTPUT
          echo "✓ Found LensCore network: $LENSCORE_NETWORK"

      - name: Prepare docker-compose.yml with LensCore network
        run: |
          NETWORK_NAME="${{ steps.get_lenscore_network.outputs.network_name }}"
          PORT="${{ steps.extract_port.outputs.port }}"

          if [ -f docker-compose.yml ]; then
            echo "✓ Found existing docker-compose.yml"
            if ! docker-compose config --services 2>/dev/null | grep -q "^app$"; then
              echo "::error::docker-compose.yml must contain a service named 'app' for your application."
              echo "Available services:"
              docker-compose config --services 2>/dev/null || echo "Invalid docker-compose.yml"
              exit 1
            fi
            echo "✓ Service 'app' found in docker-compose.yml"
            echo "::warning::Please ensure your docker-compose.yml has 'app' service in the same network as LensCore ($NETWORK_NAME)"
            echo "::warning::Add this to your 'app' service:"
            echo "::warning::  networks:"
            echo "::warning::    - lenscore"
            echo "::warning::And add this networks section:"
            echo "::warning::  networks:"
            echo "::warning::    lenscore:"
            echo "::warning::      external: true"
            echo "::warning::      name: $NETWORK_NAME"
          else
            echo "Creating docker-compose.yml with LensCore network..."
            {
              echo "services:"
              echo "  app:"
              echo "    build:"
              echo "      context: ."
              echo "      dockerfile: Dockerfile"
              echo "    ports:"
              echo "      - \"${PORT}:${PORT}\""
              echo "    environment:"
              echo "      - NODE_ENV=production"
              echo "      - PORT=${PORT}"
              echo "    networks:"
              echo "      - lenscore"
              echo ""
              echo "networks:"
              echo "  lenscore:"
              echo "    external: true"
              echo "    name: $NETWORK_NAME"
            } > docker-compose.yml
            echo "✓ Created docker-compose.yml with LensCore network"
          fi

      - name: Start application
        run: |
          docker-compose up -d --build

      - name: Wait for LensCore
        run: |
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -sf "http://localhost:3001/api/health" > /dev/null 2>&1; then
              echo "✓ LensCore is ready"
              exit 0
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done
          echo "::error::LensCore did not become available within timeout"
          docker ps -a | grep lenscore || true
          exit 1

      - name: Wait for application
        run: |
          timeout=300
          elapsed=0
          PORT="${{ steps.extract_port.outputs.port }}"
          APP_URL="${{ steps.extract_port.outputs.app_url }}"
          echo "Waiting for application at $APP_URL (service name) and http://localhost:$PORT (exposed port)..."

          echo "Checking container status..."
          docker-compose ps

          CONTAINER_STARTED=false

          while [ $elapsed -lt $timeout ]; do
            CONTAINER_STATUS=$(docker-compose ps -q app 2>/dev/null | xargs docker inspect --format='{{.State.Status}}' 2>/dev/null || echo "not-found")
            
            if [ "$CONTAINER_STATUS" = "running" ]; then
              if [ "$CONTAINER_STARTED" = "false" ]; then
                echo "✓ Container is running, waiting for application to start..."
                CONTAINER_STARTED=true
                sleep 10
                elapsed=$((elapsed + 10))
                continue
              fi
              
              if curl -sf "http://localhost:$PORT" > /dev/null 2>&1; then
                sleep 3
                CONTENT=$(curl -sL "http://localhost:$PORT" 2>/dev/null || echo "")
                if [ -n "$CONTENT" ] && ! echo "$CONTENT" | grep -qi "example domain"; then
                  echo "✓ Application is accessible at http://localhost:$PORT"
                  echo "✓ Application will be scanned at $APP_URL (Docker network)"
                  exit 0
                elif echo "$CONTENT" | grep -qi "example domain"; then
                  echo "::warning::Application returned 'Example Domain' placeholder. Waiting longer..."
                  sleep 10
                  CONTENT=$(curl -sL "http://localhost:$PORT" 2>/dev/null || echo "")
                  if echo "$CONTENT" | grep -qi "example domain"; then
                    echo "::error::Application still returning placeholder content"
                    docker-compose logs app --tail=50
                    exit 1
                  fi
                  echo "✓ Application is now accessible at http://localhost:$PORT"
                  exit 0
                fi
              else
                if [ $elapsed -ge 30 ]; then
                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$PORT" 2>/dev/null || echo "000")
                  echo "[$elapsed s] Still waiting for application to respond (HTTP: $HTTP_CODE)..."
                fi
              fi
            elif [ "$CONTAINER_STATUS" = "exited" ] || [ "$CONTAINER_STATUS" = "dead" ]; then
              echo "::error::Application container exited or died"
              docker-compose logs app --tail=50
              exit 1
            else
              echo "[$elapsed s] Waiting for container to start (status: $CONTAINER_STATUS)..."
            fi
            
            sleep 5
            elapsed=$((elapsed + 5))
          done

          echo "::error::Application did not become available within timeout ($timeout seconds)"
          echo "Container status:"
          docker-compose ps
          echo "Application logs:"
          docker-compose logs app --tail=100
          exit 1

      - name: Verify application is in LensCore network
        run: |
          NETWORK_NAME="${{ steps.get_lenscore_network.outputs.network_name }}"
          APP_CONTAINER=$(docker-compose ps -q app 2>/dev/null || echo "")

          if [ -n "$APP_CONTAINER" ]; then
            echo "Verifying application is in LensCore network: $NETWORK_NAME"
            IN_NETWORK=$(docker network inspect "$NETWORK_NAME" --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null | grep -q app && echo "yes" || echo "no")
            if [ "$IN_NETWORK" = "yes" ]; then
              echo "✓ Application is in LensCore network"
            else
              echo "::error::Application is not in LensCore network. This should not happen."
              docker network inspect "$NETWORK_NAME" --format '{{range .Containers}}{{.Name}} {{end}}' || true
              exit 1
            fi
          else
            echo "::warning::Application container not found"
          fi

      - name: Determine scan URL
        id: determine_scan_url
        run: |
          APP_URL="${{ steps.extract_port.outputs.app_url }}"
          LOCALHOST_URL="${{ steps.extract_port.outputs.localhost_url }}"
          PORT="${{ steps.extract_port.outputs.port }}"

          echo "Testing application accessibility..."
          echo "From host: curl http://localhost:$PORT"
          HOST_ACCESS=$(curl -sf "http://localhost:$PORT" > /dev/null 2>&1 && echo "yes" || echo "no")
          echo "Host access: $HOST_ACCESS"

          LENSCORE_CONTAINER=$(docker ps --filter "name=lenscore" --format "{{.Names}}" | head -1 || echo "")
          if [ -n "$LENSCORE_CONTAINER" ]; then
            echo "Testing from LensCore container: curl $APP_URL (service name)"
            CONTAINER_ACCESS_SERVICE=$(docker exec "$LENSCORE_CONTAINER" sh -c "curl -sf --max-time 5 '$APP_URL' > /dev/null 2>&1" 2>/dev/null && echo "yes" || echo "no")
            echo "Container access to $APP_URL: $CONTAINER_ACCESS_SERVICE"
            
            if [ "$CONTAINER_ACCESS_SERVICE" = "yes" ]; then
              echo "✓ LensCore container can access application via service name"
              echo "scan_url=$APP_URL" >> $GITHUB_ENV
              echo "Using: $APP_URL"
            else
              echo "Service name not accessible, trying host.docker.internal..."
              HOST_GATEWAY=$(docker exec "$LENSCORE_CONTAINER" sh -c "getent hosts host.docker.internal | awk '{print \$1}'" 2>/dev/null || echo "")
              if [ -z "$HOST_GATEWAY" ]; then
                HOST_GATEWAY=$(docker exec "$LENSCORE_CONTAINER" sh -c "ip route | grep default | awk '{print \$3}'" 2>/dev/null | head -1 || echo "")
              fi
              
              if [ -n "$HOST_GATEWAY" ]; then
                HOST_IP_URL="http://$HOST_GATEWAY:$PORT"
                echo "Testing: $HOST_IP_URL"
                CONTAINER_ACCESS_HOST=$(docker exec "$LENSCORE_CONTAINER" sh -c "curl -sf --max-time 5 '$HOST_IP_URL' > /dev/null 2>&1" 2>/dev/null && echo "yes" || echo "no")
                echo "Container access to host gateway: $CONTAINER_ACCESS_HOST"
                
                if [ "$CONTAINER_ACCESS_HOST" = "yes" ]; then
                  echo "✓ LensCore container can access application via host gateway"
                  echo "scan_url=$HOST_IP_URL" >> $GITHUB_ENV
                  echo "Using: $HOST_IP_URL"
                else
                  echo "::warning::LensCore container cannot access application. Using localhost (may not work from container)."
                  echo "scan_url=$LOCALHOST_URL" >> $GITHUB_ENV
                  echo "Using: $LOCALHOST_URL (may fail)"
                fi
              else
                echo "::warning::Could not determine host gateway. Using localhost."
                echo "scan_url=$LOCALHOST_URL" >> $GITHUB_ENV
                echo "Using: $LOCALHOST_URL"
              fi
            fi
          else
            echo "::warning::LensCore container not found. Using localhost."
            echo "scan_url=$LOCALHOST_URL" >> $GITHUB_ENV
            echo "Using: $LOCALHOST_URL"
          fi

      - name: Run scan
        run: |
          SCAN_URL="${scan_url:-${{ steps.extract_port.outputs.localhost_url }}}"
          echo "Scanning: $SCAN_URL"
          lens-core scan "$SCAN_URL" -u ${{ inputs.max_urls }} -d ${{ inputs.scan_depth }} -t ${{ inputs.timeout }} --skip-cache -o report.json || true
          if [ ! -f report.json ]; then
            echo "Scan failed, trying with test command..."
            lens-core test "$SCAN_URL" -t ${{ inputs.timeout }} --skip-cache > test_output.txt 2>&1 || true
            if [ -f test_output.txt ]; then
              if jq empty test_output.txt 2>/dev/null; then
                cp test_output.txt report-fallback.json
              else
                awk '/^\{/,/^\}$/' test_output.txt > report-fallback.json 2>/dev/null || true
                if [ ! -f report-fallback.json ] || ! jq empty report-fallback.json 2>/dev/null; then
                  jq -s '.[] | select(type == "object")' test_output.txt > report-fallback.json 2>/dev/null || true
                fi
              fi
              if [ -f report-fallback.json ] && jq empty report-fallback.json 2>/dev/null; then
                HAS_URL=$(jq -r 'if .url then "yes" else "no" end' report-fallback.json 2>/dev/null || echo "no")
                VIOLATIONS_COUNT=$(jq '.violations | length' report-fallback.json 2>/dev/null || echo "0")
                PASSES_COUNT=$(jq '.passes | length' report-fallback.json 2>/dev/null || echo "0")
                HAS_SCORE=$(jq -r 'if .score then "yes" else "no" end' report-fallback.json 2>/dev/null || echo "no")
                if [ "$HAS_URL" = "yes" ] && ([ "$VIOLATIONS_COUNT" -gt 0 ] || [ "$PASSES_COUNT" -gt 0 ] || [ "$HAS_SCORE" = "yes" ]); then
                  jq '{
                    "crawl": {"pages": [], "totalPages": 1, "crawlTime": 0},
                    "accessibility": {
                      "results": [.],
                      "totalPages": 1,
                      "testTime": (.metadata.processingTime // 0)
                    },
                    "totalTime": (.metadata.processingTime // 0)
                  }' report-fallback.json > report.json
                fi
              fi
            fi
          fi
          if [ ! -f report.json ]; then
            echo '{"accessibility":{"results":[]}}' > report.json
          fi
          VIOLATIONS=$(jq '[.accessibility.results[]? | .violations | length] | add // 0' report.json)
          echo "Total violations: $VIOLATIONS"
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "=========================================="
            echo "ACCESSIBILITY VIOLATIONS DETECTED"
            echo "=========================================="
            echo ""
            PAGE_COUNT=$(jq '.accessibility.results | length' report.json)
            echo "Pages scanned: $PAGE_COUNT"
            echo "Total violations: $VIOLATIONS"
            echo ""
            echo "--- Violation Details ---"
            jq -r '.accessibility.results[]? | 
              "Page: \(.url // "Unknown")",
              (.violations[]? | 
                "  ❌ \(.id // "unknown") [\(.impact // "unknown")]",
                "     Description: \(.description // "N/A")",
                "     Help: \(.help // "N/A")",
                "     Help URL: \(.helpUrl // "N/A")",
                (.nodes[]? | 
                  "     - Element: \(.target | join(", ") // "N/A")",
                  "       HTML: \(.html // "N/A" | .[0:100])",
                  "       Summary: \(.failureSummary // .any[]?[0].message // "N/A" | .[0:200])"
                ),
                ""
              )
            ' report.json || true
            echo ""
            echo "=========================================="
            echo "How to fix:"
            echo "  1. Review each violation above"
            echo "  2. Check the Help URL for detailed guidance"
            echo "  3. Fix the issues in your code"
            echo "  4. Re-run the workflow to verify fixes"
            echo "=========================================="
            echo ""
            echo "::error::Accessibility violations detected: $VIOLATIONS"
          exit 1
          fi
          echo "No violations found"

      - name: Generate HTML report
        run: |
          SCAN_URL="${scan_url:-${{ steps.extract_port.outputs.localhost_url }}}"
          lens-core scan "$SCAN_URL" -u ${{ inputs.max_urls }} -d ${{ inputs.scan_depth }} -t ${{ inputs.timeout }} --skip-cache --web || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lenscore-accessibility-report
          path: |
            report.json
          retention-days: 7
          if-no-files-found: warn

      - name: Stop services
        if: always()
        run: |
          docker-compose down -v || true
          lens-core down || true
